suite: "dds resources basic checks"

templates:
  - "templates/deployment.yaml"

tests:
  # ServiceAccount
  - it: "renders ServiceAccount dds-controller-manager in composable-dra"
    set:
      common:
        name: dynamic-device-scaler
        image:
          registry: example.io
          repository: example/dds
          tag: 0.4.0
          pullPolicy: IfNotPresent
        env:
          SCAN_INTERVAL: "10"
          DEVICE_NO_REMOVAL_DURATION: "10"
          DEVICE_NO_ALLOCATION_DURATION: "10"
    asserts:
      - isKind:
          of: ServiceAccount
        documentIndex: 0
      - equal:
          path: metadata.name
          value: dds-controller-manager
        documentIndex: 0
      - equal:
          path: metadata.namespace
          value: composable-dra
        documentIndex: 0

  # ClusterRoleBinding
  - it: "renders ClusterRoleBinding dds-manager-rolebinding for dds-controller-manager"
    set:
      common:
        name: dynamic-device-scaler
        image:
          registry: example.io
          repository: example/dds
          tag: 0.4.0
          pullPolicy: IfNotPresent
        env:
          SCAN_INTERVAL: "10"
          DEVICE_NO_REMOVAL_DURATION: "10"
          DEVICE_NO_ALLOCATION_DURATION: "10"
    asserts:
      - isKind:
          of: ClusterRoleBinding
        documentIndex: 2
      - equal:
          path: metadata.name
          value: dds-manager-rolebinding
        documentIndex: 2
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
        documentIndex: 2
      - equal:
          path: subjects[0].name
          value: dds-controller-manager
        documentIndex: 2
      - equal:
          path: subjects[0].namespace
          value: composable-dra
        documentIndex: 2

  # Deployment
  - it: "renders Deployment dds-controller-manager with non-empty env vars"
    set:
      common:
        name: dynamic-device-scaler
        image:
          registry: example.io
          repository: example/dds
          tag: 0.4.0
          pullPolicy: Never
        env:
          SCAN_INTERVAL: "10"
          DEVICE_NO_REMOVAL_DURATION: "10"
          DEVICE_NO_ALLOCATION_DURATION: "10"
    asserts:
      - isKind:
          of: Deployment
        documentIndex: 3
      - equal:
          path: metadata.name
          value: dds-controller-manager
        documentIndex: 3
      - equal:
          path: metadata.namespace
          value: composable-dra
        documentIndex: 3
      - equal:
          path: spec.template.spec.containers[0].image
          value: "example.io/example/dds:0.4.0"
        documentIndex: 3
      - equal:
          path: spec.template.spec.containers[0].imagePullPolicy
          value: Never
        documentIndex: 3
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: SCAN_INTERVAL
            value: "10"
        documentIndex: 3
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DEVICE_NO_REMOVAL_DURATION
            value: "10"
        documentIndex: 3
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: DEVICE_NO_ALLOCATION_DURATION
            value: "10"
        documentIndex: 3
