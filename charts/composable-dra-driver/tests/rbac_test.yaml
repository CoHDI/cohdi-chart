suite: Test RBAC Rendering
templates:
  - templates/deployment.yaml

tests:
  - it: should create ServiceAccount with correct name
    set:
      common:
        name: cdi-dra
        image:
          registry: example.io
          repository: example/cdi-dra:latest
          tag: 0.4.0
          pullPolicy: Never
      global:
        fti_cdi:
          hostAliases:
            - ip: "111.111.111.111"
              hostnames:
                - "cdimgr.localdomain"
          env:
            CDI_ENDPOINT: "https://cdimgr.localdomain"
            TENANT_ID: "060ea5a5-46e4-42b4-8d95-70578718d8d0"
    documentSelector:
      path: kind
      value: ServiceAccount
    asserts:
      - isKind:
          of: ServiceAccount
      - equal:
          path: metadata.name
          value: cdi-dra

  - it: should create ClusterRoleBinding with correct name and subject
    set:
      common:
        name: cdi-dra
        image:
          registry: example.io
          repository: example/cdi-dra:latest
          tag: 0.4.0
          pullPolicy: Never
      global:
        fti_cdi:
          hostAliases:
            - ip: "111.111.111.111"
              hostnames:
                - "cdimgr.localdomain"
          env:
            CDI_ENDPOINT: "https://cdimgr.localdomain"
            TENANT_ID: "060ea5a5-46e4-42b4-8d95-70578718d8d0"
    documentSelector:
      path: kind
      value: ClusterRoleBinding
    asserts:
      - isKind:
          of: ClusterRoleBinding
      - equal:
          path: metadata.name
          value: cdi-dra-binding
      - equal:
          path: subjects[0].kind
          value: ServiceAccount
      - equal:
          path: subjects[0].name
          value: cdi-dra
